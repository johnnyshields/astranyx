# Weapon System Implementation

## Overview

Implemented an weapon pickup system with 16 weapons across 4 ammo types. Weapons are dropped by enemies, picked up by players, and fire using secondary input with limited ammo.

## Weapons (16 total)

### BULLET (5 weapons)
| Code | Name | Description |
|------|------|-------------|
| vulcan | Vulcan | Minigun, rapid fire |
| shotgun | Bulldog | Wide spread, short range |
| spread_small | Jericho | 5-way spread |
| spread_large | Kitsune | 9-way spread |
| railgun | Odin | Piercing beam |

### BOMB (4 weapons)
| Code | Name | Description |
|------|------|-------------|
| missile | Hornet | Homing torpedo |
| cannon | Megiddo | Explosive shell |
| mine | Limpet | Deployable homing mine |
| grenade | Magus | Area effect |

### OIL (2 weapons)
| Code | Name | Description |
|------|------|-------------|
| flame | Diablo | Flamethrower |
| acid | Slag | Caustic spray |

### ENERGY (5 weapons)
| Code | Name | Description |
|------|------|-------------|
| sonic | Banshee | Sonic wave |
| laser_small | Lancet | Thin piercing laser |
| laser_large | Paladin | Charge laser |
| lightning | Valkyrie | Chain lightning |
| sword | Durandal | Energy sword |

## Controls

- **Primary Fire** (Space): Base gun (powerup-enhanced)
- **Secondary Fire** (Shift): Equipped weapon (uses ammo)
- **Swap Weapon** (Q): Cycle through equipped weapons
- **Pickup Weapon** (E): Manual pickup when slots full

## Files Created/Modified

### `src/game/Weapons.ts` (NEW)
Central weapon configuration:
- `WeaponType`, `AmmoType` type definitions
- `WEAPON_STATS` - Complete stats for all 16 weapons
- `WEAPON_BULLET_TYPE` - Maps weapons to projectile visual types
- `AMMO_TYPE_COLORS`, `WEAPON_COLORS` - Rendering colors
- `getAvailableWeapons(wave)` - Wave-based weapon availability

### `src/game/Simulation.ts`
Extended player and state:
```typescript
interface Player {
  weaponSlots: PlayerWeapon[]
  activeWeaponIndex: number
  maxWeaponSlots: number  // 2
}

interface GameState {
  weaponDrops: WeaponDrop[]
}
```

Weapon firing system:
- `fireWeapon()` - Dispatcher based on weapon special behavior
- `fireStandardWeapon()` - Spread weapons (vulcan, shotgun, jericho, kitsune)
- `fireHomingMissile()` - Hornet homing missiles
- `fireExplosiveShell()` - Cannon/grenade explosives
- `fireContinuous()` - Flamethrower continuous fire
- `fireAcidBlob()` - Acid puddle projectiles
- `fireSonicWave()` - Expanding sonic waves
- `fireLaserBeam()` - Instant beam weapons (Lancet, Paladin)
- `fireLightning()` - Chain lightning
- `swingSword()` - Melee attack
- `fireRailgun()` - Instant hit piercing

Pickup system:
- `spawnWeaponDrop()` - Creates weapon drops from enemies
- `updateWeaponDrops()` - Movement and despawn
- `tryAutoPickup()` - Automatic pickup when slots available
- `tryManualPickup()` - E key pickup, drops current weapon if full
- `cycleWeapon()` - Q key weapon swap

### `src/core/Input.ts`
Added input fields:
```typescript
interface InputState {
  secondary: boolean  // Shift key
  swap: boolean       // Q key (edge-triggered)
  pickup: boolean     // E key (edge-triggered)
}
```

### `src/network/LockstepNetcode.ts`
Extended `PlayerInput` for network sync:
```typescript
interface PlayerInput {
  secondary: boolean
  swap: boolean
  pickup: boolean
}
```

## Bugs Fixed

### Missile Coordinate System Bug
**Problem**: Hornet missiles always fired from center of screen.

**Root Cause**: Mixed coordinate systems. Missiles stored world coordinates but `updateMissiles()` incorrectly called `fromFixed()` on them, dividing by 65536.

**Fix**: Made missile system consistently use world coordinates:
- Removed erroneous `fromFixed()` calls in `updateMissiles()`
- Fixed collision checking to use world coords directly
- Added `toFixed()` when calling `spawnExplosion()` (expects fixed-point)

### Projectile Visual Types
**Problem**: All weapons fired cyan 'shot' bullets regardless of type.

**Fix**:
1. Added `WEAPON_BULLET_TYPE` mapping in Weapons.ts
2. Added 'flame' and 'acid' to `BulletType` enum
3. Added flame/acid colors to Game.ts COLORS
4. Updated firing functions to use mapped bullet types

### Beam Rendering
**Problem**: Lancet beam appeared as tiny square instead of screen-spanning laser.

**Root Cause**: `renderBeam()` used `beam.width` (thickness: 8 or 20) for horizontal length.

**Fix**: Calculate beam length to extend from origin to past screen edge:
```typescript
const beamLength = 500 - beam.x + 50  // Extend to right edge + buffer
const beamThickness = beam.width
```

## Weapon Availability by Wave

```
Wave 1-2:  vulcan, shotgun, spread_small
Wave 3-4:  + missile, flame
Wave 5-6:  + spread_large, cannon, sonic
Wave 7-8:  + grenade, acid, laser_small
Wave 9-11: + lightning, laser_large
Wave 12+:  + railgun, mine, sword
```

## Determinism

All weapon systems maintain determinism for P2P lockstep:
- `state.rng` used for weapon drop selection
- Fixed-point math for positions/velocities
- Edge-triggered inputs sync via netcode
- No `Math.random()` or `Date.now()`
